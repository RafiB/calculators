{% extends 'common.html' %}

{% block head %}
    {{ super() }}
    <script type='text/javascript' src='http://ajax.aspnetcdn.com/ajax/jquery.validate/1.14.0/jquery.validate.min.js'></script>
{% endblock %}

{% block body -%}
  <body class='container'>
    <div class='col-xs-12'>
      <form id='search-box'>
        <div group='form-group'>
          <input class='form-control typeahead' type='text' placeholder='Find a calculator'>
        </div>
        <span id='permalink'></span>
      </form>
    </div>
    <div class='col-md-6'>
      <div id='calculator-form-wrapper'>
      {% if variables %}
        <form method='POST' id='calculator-form'>
          <input type='hidden' name='calculator' value='{{ calculator_name }}'>
        {%- for variable in variables -%}
          {%- set label = labels[variable][0] -%}
          {%- set type = labels[variable][1] %}

          <div class='form-group'>
            <label for='{{ variable }}'>{{ label }}</label>

          {%- if type != 'number' %}
            <div class='input-group'>
          {%- endif %}

          {%- set group_before -%}
            {%- if type in g.group_before -%}
              <div class='input-group-addon'>{{ g.group_before[type] }}</div>
            {%- endif -%}
          {%- endset -%}

          {%- set group_after %}
            {%- if type in g.group_after %}
              <div class='input-group-addon'>{{ g.group_after[type] }}</div>
            {%- endif -%}
          {%- endset %}

              {{ group_before|safe }}
              <input required type='number' step='0.01' class='form-control' name='{{ variable }}' id='{{ variable }}'>
              {{ group_after|safe -}}

          {%- if type != 'number' %}
            </div>
          {%- endif %}
          </div>
        {%- endfor %}
          <button type='submit' class='pull-right btn btn-primary'>Calculate</button>
          = <span id='answer'></span><span id='form-error' style='color: red;'></span>
        </form>
      {% endif %}
      </div>
      <script type='text/javascript'>
        function process_form_fail(data) {
          data = JSON.parse(data.responseText);
          if ('missing' in data) {
            data.missing.forEach(function(m) {
              $('#'+m+'-error').show().text('This field is required.');
            });
          } else if ('message' in data) {
            $('#answer').text('');
            $('#form-error').text(data.message).show();
          }
        }

        function set_form(page) {
          /* We're given an HTML page in a string. Parse it and grab #calculator-form
             from the page, then place the form into #calculator-form-wrapper on this
             page. */
          $('#calculator-form-wrapper').html($('#calculator-form', page));

          /* Set up the form validator */
          var validator = $('#calculator-form').validate();

          /* Capture the form submission */
          $('#calculator-form').on('submit', function(e) {
            e.preventDefault();

            var form_data = {};
            $('#calculator-form :input').serializeArray().forEach(function(o) {
              form_data[o.name] = o.value;
            });

            $.post('{{ url_for('Endpoint:calculate') }}', form_data, function(data) {
              $('#form-error').hide();
              $('#answer').text(data);
            }).fail(function(data) {
              process_form_fail(data);
            });

            return false;
          });
        }

        $(function() {
          var calculators = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.whitespace,
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            remote: {
              url: '{{ url_for('Endpoint:search_by_tags', search_string='') }}' + '%QUERY',
              wildcard: '%QUERY'
            }
          });

          $('input.typeahead').typeahead({
            highlight: true
          }, {
            name: 'calculators',
            displayKey: 'name',
            templates: {
              suggestion: function(data) {
                return '<p><strong>' + data.name + '</strong> (' + data.tags.join(', ') + ')</p>';
              }
            },
            source: calculators
          });

          $('input.tt-input').bind('typeahead:selected', function(obj, datum, name) {
            var link = '{{ url_for('Index:calculator_permalink_1', _external=True) }}/' + datum.id;
            var permalink = $('<a>', {
              text: 'Permalink: ' + link,
              href: link
            });

            $('#permalink').html(permalink).show();

            $.post('{{ url_for('Endpoint:get_html_form_by_id') }}',
              {'id': datum.id},
              set_form
            );
          });
        });
      </script>
    </div>
  </body>
{% endblock %}
